
extends layout

block content
  .container.mt-5.mb-5
    .card.shadow
      .card-body.p-4
        .text-center.mb-4
          img(src="/img/sistemhisimg.png" alt="Logo" width="100")
          h3.text-primary.mt-2 Registrar Admisión

        form(action="/admision" method="POST")
          .mb-3
            label.form-label DNI del Paciente
            input.form-control(type="text", id="dniInput", placeholder="Escriba el DNI", required)
            input(type="hidden", name="pacienteId", id="pacienteId")

          .mb-3
            label.form-label Fecha de ingreso
            input.form-control(type="date", name="fecha_ingreso", required)

          .mb-3
            label.form-label Motivo de admisión
            input.form-control(type="text", name="motivo", placeholder="Ej: Neumonía", required)
          .mb-3
            label.form-label Tipo de ingreso
            select.form-select(name="tipo_ingreso", required)
              option(value="Programado") Programado
              option(value="Derivación") Derivación
              option(value="Emergencia") Emergencia

          .form-check.form-switch.mb-3
            input.form-check-input(type="checkbox", name="derivado_guardia")
            label.form-check-label(for="derivado_guardia") Derivado por Guardia

          .text-center.mt-4
            button.btn.btn-primary(type="submit") Registrar Admisión
    hr.my-5

    h4.text-center.mt-5.mb-3 Lista de Admisiones
    .row.mb-3
      .col-md-6
        input.form-control(type="text", id="filtroDNI", placeholder="Filtrar por DNI...")
      .col-md-6
        select.form-select(id="filtroTipoIngreso")
          option(value="") Filtrar por Tipo de Ingreso
          option(value="Programado") Programado
          option(value="Derivación") Derivación
          option(value="Emergencia") Emergencia


    table.table.table-bordered.table-hover.mt-3
      thead.table-dark
        tr
          th Fecha Ingreso
          th Motivo
          th Tipo de Ingreso
          th Derivado
          th DNI Paciente
          th Nombre Paciente
      tbody#tablaAdmisiones
        each admision in admisiones
          tr
            td= admision.fecha_ingreso
            td= admision.motivo
            td= admision.tipo_ingreso
            td= admision.derivado_guardia ? "Sí" : "No"
            td= admision.Paciente && admision.Paciente.dni
            td= admision.Paciente && admision.Paciente.nombre_completo

block scripts
  script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js")
  script.
    document.addEventListener("DOMContentLoaded", function () {
      const dniInput = document.getElementById("dniInput");
      const pacienteIdInput = document.getElementById("pacienteId");

      if (dniInput) {
        dniInput.addEventListener("input", async function () {
          const dni = this.value.trim();
          if (dni.length >= 6) {
            try {
              const res = await fetch(`/admision/buscar?dni=${dni}`);
              const paciente = await res.json();
              if (paciente && paciente.id) {
                pacienteIdInput.value = paciente.id;
                this.classList.remove("is-invalid");
              } else {
                pacienteIdInput.value = "";
                this.classList.add("is-invalid");
              }
            } catch (err) {
              console.error("Error en búsqueda AJAX", err);
            }
          }
        });
      }
      const filtroInput = document.getElementById("filtroDNI");
      if (filtroInput) {
        filtroInput.addEventListener("input", function () {
          const filtro = this.value.trim().toLowerCase();
          const filas = document.querySelectorAll("#tablaAdmisiones tr");

          filas.forEach(fila => {
            const celdaDNI = fila.children[3];
            const valorDNI = celdaDNI?.textContent.toLowerCase();
            fila.style.display = valorDNI.includes(filtro) ? "" : "none";
          });
        });
      }
    });