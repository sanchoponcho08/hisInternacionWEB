extends layout

block content
  .container.mt-4
    h2.text-center.mb-4 Registrar nuevo paciente

    form(action="/pacientes" method="POST").mb-5
      .row.g-3
        .col-md-6
          label.form-label Nombre completo
          input.form-control(type="text" name="nombre_completo" required)

        .col-md-6
          label.form-label DNI
          input.form-control(type="number" name="dni" required)

        .col-md-6
          label.form-label Sexo
          select.form-select(name="sexo" required)
            option(value="Masculino") Masculino
            option(value="Femenino") Femenino

        .col-md-6
          label.form-label Fecha de nacimiento
          input.form-control(type="date" name="fecha_nacimiento" required)

        .col-md-6
          label.form-label Dirección
          input.form-control(type="text" name="direccion")

        .col-md-6
          label.form-label Teléfono
          input.form-control(type="text" name="telefono")

        .col-md-6
          label.form-label Contacto de Emergencia
          input.form-control(type="text" name="contacto_emergencia")

        .col-md-6
          label.form-label Obra Social
          input.form-control(type="text" name="obra_social")

        .col-md-6
          label.form-label Localidad
          input.form-control(type="text" name="localidad")

      .text-center
        button.btn.btn-primary.mt-3(type="submit") Registrar Paciente

    hr

    h3.text-center.mt-5 Pacientes Registrados
    input#busquedaDNI.form-control.mb-3(type="text", placeholder="Filtrar por DNI...")
    table#tablaPacientes.table.table-bordered.table-hover.mt-3
      thead.table-dark
        tr
          th DNI
          th Nombre
          th Fecha Nac.
          th Sexo
          th Obra Social
      tbody
        each paciente in pacientes
          tr
            td= paciente.dni
            td= paciente.nombre_completo
            td= paciente.fecha_nacimiento
            td= paciente.sexo
            td= paciente.obra_social


    div#pacienteModal.modal.fade(tabindex='-1')
      .modal-dialog
        .modal-content
          .modal-header
            h5.modal-title Detalle del Paciente
            button.btn-close(type='button', data-bs-dismiss='modal')
          .modal-body
            p DNI: #[span#modalDni]
            p Nombre: #[span#modalNombre]
            p Fecha Nac.: #[span#modalFecha]
            p Sexo: #[span#modalSexo]
            p Obra Social: #[span#modalObra]
          .modal-footer
            a#editarBtn.btn.btn-primary(href='#') Editar
            button#eliminarBtn.btn.btn-danger Eliminar
            button.btn.btn-secondary(data-bs-dismiss='modal') Cerrar        
block scripts
  script.
    document.getElementById('busquedaDNI').addEventListener('input', function () {
      const filtro = this.value.toLowerCase();
      const filas = document.querySelectorAll('#tablaPacientes tbody tr');
      
      filas.forEach(fila => {
        const dni = fila.children[0].textContent.toLowerCase();
        fila.style.display = dni.includes(filtro) ? '' : 'none';
      });
    });


    const filas = document.querySelectorAll("#tablaPacientes tbody tr");
    const modal = new bootstrap.Modal(document.getElementById('pacienteModal'));

    filas.forEach(fila => {
      fila.addEventListener("click", () => {
        const dni = fila.dataset.dni;
        const nombre = fila.dataset.nombre;
        const fecha = fila.dataset.fecha;
        const sexo = fila.dataset.sexo;
        const obra = fila.dataset.obra;

        document.getElementById("modalDni").textContent = dni;
        document.getElementById("modalNombre").textContent = nombre;
        document.getElementById("modalFecha").textContent = fecha;
        document.getElementById("modalSexo").textContent = sexo;
        document.getElementById("modalObra").textContent = obra;

        document.getElementById("editarBtn").href = `/pacientes/editar/${dni}`;
        document.getElementById("eliminarBtn").onclick = () => {
          if (confirm("¿Seguro que querés eliminar este paciente?")) {
            fetch(`/pacientes/eliminar/${dni}`, { method: 'DELETE' })
              .then(res => res.ok ? location.reload() : alert("Error al eliminar"));
          }
        };

        modal.show();
      });
    });